---
title: "Pożyczki"
author: "Aleksandra, Cezary, Karolina"
output: html_document
---

```{r, include = FALSE}
# instalacja (jeśli potrzeba) i załadowanie niezbędnych pakietów
if (!require(knitr)) install.packages("knitr")
library(knitr)
if (!require(tidyverse)) install.packages("tidyverse")
library(tidyverse)
if (!require(gridExtra)) install.packages("gridExtra")
library(gridExtra)
if (!require(psych)) install.packages("psych")
library(psych)
if (!require(ipred)) install.packages("ipred")
library(ipred)
if (!require(rpart)) install.packages("rpart")
library(rpart)
if (!require(rpart.plot)) install.packages("rpart.plot")
library(rpart.plot)

# szerokość wydruku
options(width = 150)
```

# Wstęp
## Opis problemu
Celem niniejszego opracowania jest budowa klasyfikatora, który pozwoli możliwie dokładnie przewidzieć decyzję dotyczącą przyznania pożyczki klientom pewnej firmy pożyczkowej.

## Baza danych
Podstawą analizy jest baza danych klientów firmy pożyczkowej.

```{r}
# wczytanie danych
sciezka <- "/Users/czare/Desktop/Analiza Grupa C/pozyczki.csv"
dane <- read.csv(sciezka)

# wyświetlenie pierwszych wierszy danych
kable(head(dane))
```

```{r}
# wyświetlanie danych
str(dane)
```

## Zmienne
Zmienną objaśnianą jest zmienna `Loan_Status` określająca, czy danej osobie przyznano pożyczkę (Y/N).

Zmienne objaśniające to głównie zmienne socjo-demograficzne oraz informacje finansowe.

```{r}
# nazwy zmiennych objaśniających
data.frame(zmienna = names(dane)[2:12])
```

## Czyszczenie dancyh 

Pierwsza kolumna w bazie danych (`Loan_ID`) określa numer identyfikacyjny, ją możemy pominąć.

```{r}
# usunięcie pierwszej kolumny
dane <- dane %>%
  select(-1)
```

Mamy 614 obserwacji (klientów firmy) opisanych przez 12 zmiennych.

## Dodanie kolumny pomocniczej 

Dodanie kolumny Total income, która pokazuję dochód dwoch osób składających wniosek. Total income by one, pokazuję dochód całkowity dochód przeliczając na jedną osobę.

```{r}
dane <- dane %>%
  mutate(Total_income = (ApplicantIncome + CoapplicantIncome))
dane <- dane %>%
  mutate(Total_income_by_one = (ApplicantIncome + CoapplicantIncome)/2)
```

## Usunięcie N/A 

```{r}
dane_na <- na.omit(dane)
```

# Wizualizacja danych


## Czy otrzymał pożyczkę?

```{r}
tab <- as.data.frame(100*prop.table(table(dane_na$Loan_Status)))
ggplot(tab, aes(x = Var1, y = Freq)) + 
  geom_col(fill = "#FFFF99", colour = "black") +
  geom_text(aes(label = paste0(round(Freq,1),"%")), 
            stat = "identity", size = 5, 
            fontface = "bold", position = position_stack(vjust = 0.5)) +
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_text(colour = "black", size = 10),
        plot.title = element_text(hjust = 0.5, size = 12)) +
  labs(title = "Czy otrzymał pożyczkę?",
       y = "%")
```

W badanej grupie klientów firmy znalazło się aż 68,7% osób z przyznaną pożyczką. Decyzję odmowną uzyskało 31,3% z nich.

## Płeć
```{r}
tab <- as.data.frame(100*prop.table(table(dane_na$Gender)))
plot1 <- ggplot(tab, aes(x = Var1, y = Freq)) + 
  geom_col(fill = "#FFFF99", colour = "black") +
  geom_text(aes(label = paste0(round(Freq,1),"%")), 
            stat = "identity", size = 4, 
            fontface = "bold", position = position_stack(vjust = 0.5)) +
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_text(colour = "black", size = 10),
        plot.title = element_text(hjust = 0.5, size = 12)) +
  labs(title = "Płeć",
       y = "%")
grid.arrange(plot1)
```
Główną część wnioskujących stanowią mężczyźni i stanowią prawie 80% wnioskująych. 

## Status związku
```{r}
tab <- as.data.frame(100*prop.table(table(dane$Married)))
plot2 <- ggplot(tab, aes(x = Var1, y = Freq)) + 
  geom_col(fill = "#FFFF99", colour = "black") +
  geom_text(aes(label = paste0(round(Freq,1),"%")), 
            stat = "identity", size = 4, 
            fontface = "bold", position = position_stack(vjust = 0.5)) +
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_text(colour = "black", size = 10),
        plot.title = element_text(hjust = 0.5, size = 12)) +
  labs(title = "Małżeństwo",
       y = "%")

grid.arrange(plot2)
```

Wiekszość osób wnioskujących to osoby w związku małżeńskim.

## Ilość osób na utrzymaniu
```{r}
tab <- as.data.frame(100*prop.table(table(dane$Dependents)))
plot3 <- ggplot(tab, aes(x = Var1, y = Freq)) + 
  geom_col(fill = "#FFFF99", colour = "black") +
  geom_text(aes(label = paste0(round(Freq,1),"%")), 
            stat = "identity", size = 3, 
            fontface = "bold", position = position_stack(vjust = 0.5)) +
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_text(colour = "black", size = 10),
        plot.title = element_text(hjust = 0.5, size = 12)) +
  labs(title = "Ilość osób na utrzymaniu",
       y = "%")

grid.arrange(plot3)
```

Znacząca wiekszość wnioskujących to osobne nie posiadające osób na utrzymaniu, przeszło 55,8%.

## Poziom edukacji
```{r}
tab <- as.data.frame(100*prop.table(table(dane$Education)))
plot4 <- ggplot(tab, aes(x = Var1, y = Freq)) + 
  geom_col(fill = "#FFFF99", colour = "black") +
  geom_text(aes(label = paste0(round(Freq,1),"%")), 
            stat = "identity", size = 4, 
            fontface = "bold", position = position_stack(vjust = 0.5)) +
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_text(colour = "black", size = 10),
        plot.title = element_text(hjust = 0.5, size = 12)) +
  labs(title = "Poziom edukacji",
       y = "%")

grid.arrange(plot4)
```

Zdecydowana większość osób to osoby wykształcone, w przynajmniej podstawowym stopniu.

## Osoby na samozatrudnieniu 
```{r}
tab <- as.data.frame(100*prop.table(table(dane$Self_Employed)))
plot5 <- ggplot(tab, aes(x = Var1, y = Freq)) + 
  geom_col(fill = "#FFFF99", colour = "black") +
  geom_text(aes(label = paste0(round(Freq,1),"%")), 
            stat = "identity", size = 4, 
            fontface = "bold", position = position_stack(vjust = 0.5)) +
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_text(colour = "black", size = 10),
        plot.title = element_text(hjust = 0.5, size = 12)) +
  labs(title = "Samozatrudniene",
       y = "%")

grid.arrange(plot5)
```

Zaledwie 13% osób jest na samozatrudnieniu.

## Historia kredytowa 
```{r}
tab <- as.data.frame(100*prop.table(table(dane$Credit_History)))
plot6 <- ggplot(tab, aes(x = Var1, y = Freq)) + 
  geom_col(fill = "#FFFF99", colour = "black") +
  geom_text(aes(label = paste0(round(Freq,1),"%")), 
            stat = "identity", size = 4, 
            fontface = "bold", position = position_stack(vjust = 0.5)) +
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_text(colour = "black", size = 10),
        plot.title = element_text(hjust = 0.5, size = 12)) +
  labs(title = "Historia kredytowa",
       y = "%")

grid.arrange(plot6)
```

85% to osoby posiadające historię kredytową.

## Lokalizacja 
```{r}
tab <- as.data.frame(100*prop.table(table(dane$Property_Area)))
plot7 <- ggplot(tab, aes(x = Var1, y = Freq)) + 
  geom_col(fill = "#FFFF99", colour = "black") +
  geom_text(aes(label = paste0(round(Freq,1),"%")), 
            stat = "identity", size = 4, 
            fontface = "bold", position = position_stack(vjust = 0.5)) +
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_text(colour = "black", size = 10),
        plot.title = element_text(hjust = 0.5, size = 12)) +
  labs(title = "Lokalizacja",
       y = "%")

grid.arrange(plot7)
```

Podział w miarę równy pomiędzy 3 typy lokalizacji. Jednak delikatnie przeważa ilość osób w częsciowo zurbanizowanej lokalizacji.


## Okres spłaty pożyczki

Interesuję nas na jaki okres udzielano pożyczki. 

```{r}
tab <- as.data.frame(table(dane$Loan_Amount_Term))
plot1t <- ggplot(tab, aes(x = Var1, y = Freq)) + 
  geom_col(fill = "#FFFF99", colour = "black") +
  geom_text(aes(label = paste0(round(Freq, 1), "")), 
            stat = "identity", size = 4, 
            fontface = "bold", position = position_stack(vjust = 0.5)) +
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_text(colour = "black", size = 10),
        plot.title = element_text(hjust = 0.5, size = 12)) +
  labs(title = "Loan Amount Term",
       y = "")
print(plot1t)
```







dotąd przerobione






# Ilościowe zmienne objaśniające
Dla ilościowych zmiennych objaśniających obliczamy najpierw podstawowe miary rozkładu.

```{r}
# statystyki opisowe
kable(describe(dane[,6:9])[c(2:5,8,9,11,12)])
```

W przypadku zmiennych `LoanAmount` i `Loan_Amount_Term` mamy braki danych (n<614). W powyższej tabeli zawarte są podstawowe miary położenia, rozproszenia, asymterii i skupienia.

Średni dochód aplikującego o pożyczkę w badanej grupie klientów to 5403,46 dolarów, przy czym dochody poszczególnych osób różnią się od średniej przeciętnie o 6109,04 dolarów. Dla połowy osób dochód nie przekracza 3812,50 dolarów. Najmniejsza zaobserwowana wartość to 150 dolarów, a największa aż 81000 dolarów. W rozkładzie występuje skrajna asymetria prawostronna, jest on też wyższy i smuklejszy od rozkładu normalnego.

Dla pozostałych zmiennych wyniki interpretuje się analogicznie. Zakresy osiąganych wartości są tutaj sensowne, nie ma żadnych wartości ujemnych. Jedyny problem stanowią bardzo duże wartości skupienia i kurtozy, na które wpływ mają najprawdopodobniej obserwacje odstające.

Do prezentacji graficznej sporządzamy histogramy.

```{r, warning = FALSE}
# histogramy
plot1 <- ggplot(dane, aes(x = ApplicantIncome)) + 
  geom_histogram(colour = "black", fill = "#FFFF99", bins = 10) +
  labs(title = "Applicant Income", 
       x = "dollars", y = "n") +
  theme(plot.title = element_text(hjust = 0.5, size = 12))

plot2 <- ggplot(dane, aes(x = CoapplicantIncome)) + 
  geom_histogram(colour = "black", fill = "#FFFF99", bins = 10) +
  labs(title = "Coapplicant Income", 
       x = "dollars", y = "n") +
  theme(plot.title = element_text(hjust = 0.5, size = 12))

plot3 <- ggplot(dane, aes(x = LoanAmount)) + 
  geom_histogram(colour = "black", fill = "#FFFF99", bins = 10) +
  labs(title = "Loan Amount", 
       x = "dollars", y = "n") +
  theme(plot.title = element_text(hjust = 0.5, size = 12))

plot4 <- ggplot(dane, aes(x = Loan_Amount_Term)) + 
  geom_histogram(colour = "black", fill = "#FFFF99", bins = 10) +
  labs(title = "Loan Amount Term", 
       x = "months", y = "n") +
  theme(plot.title = element_text(hjust = 0.5, size = 12))

grid.arrange(plot1, plot2, plot3, plot4, nrow = 2)
```

Rozkłady zmiennych są bardzo nieregularne. W przypadku trzech pierwszych mamy skrajną asymetrię prawostronną (wydłużone ramię z prawej strony histogramu). Dla ostatniej zmiennej asymetria jest lewostronna.

